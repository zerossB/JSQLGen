package gen.gui;

/**
 *
 * @author marcos
 */
public class ClassTabViewGen {

    private project.Project proj;
    private project.ClassBean classBean;

    /**
     * Construtor
     * @param proj
     * @param classBean 
     */
    public ClassTabViewGen(project.Project proj, project.ClassBean classBean){
        this.proj = proj;
        this.classBean = classBean;
    }
    
    /**
     * 
     * @param att
     * @return 
     */
    private AttributeGen getAttributeGen(project.Attribute att){
        switch(att.getType()){
            case IDENTITY    : return new AttributeIdentityGen(classBean, att);
            case INTEGER     : return new AttributeIntegerGen(classBean, att);
            case FLOAT       : return new AttributeFloatGen(classBean, att);
            case BOOLEAN     : return new AttributeBooleanGen(classBean, att);
            case STRING      : return new AttributeStringGen(classBean, att);
            case DATE        : return new AttributeDateGen(classBean, att);
            case TIME        : return new AttributeTimeGen(classBean, att);
            case IMAGE       : return new AttributeImageGen(classBean, att);
            case FIXED_LIST  : return new AttributeFixedListGen(classBean, att);
            case OBJECT      : return new AttributeObjectGen(proj, classBean, att);
            case OBJECT_LIST : return new AttributeObjectListGen(proj, classBean, att);
            default: return null;
        }
    }
    
    public String getJavaCode(){
        String code = "";
        code += "package "+classBean.getPackage(proj)+";\n";
        code += "/**\n";
        code += " *\n";
        code += " * @author marcos\n";
        code += " */\n";
        code += "public class "+classBean.getName()+"Tab extends javax.swing.JDialog {\n";
        code += "    private java.sql.Connection connection;\n";
        code += "    private java.util.List list;\n";
        code += "\n";

        code += "    /** Creates new form "+classBean.getName()+"Tab */\n";
        code += "    public "+classBean.getName()+"Tab(java.awt.Window parent, java.sql.Connection connection) {\n";
        code += "        super(parent);\n";
        code += "        this.connection = connection;\n";
        code += "        initComponents();\n";
        code += "        list = new java.util.ArrayList();\n";
        code += "        refresh();\n";
        code += "        this.setVisible(true);\n";
        code += "    }\n";

        code += "\n";
        code += "    /** Atualiza tabela */\n";
        code += "    private void refresh() {\n";
        code += "        javax.swing.table.DefaultTableModel mTable = (javax.swing.table.DefaultTableModel)tTable.getModel();\n";
        code += "        int lineSel = tTable.getSelectedRow();\n";
        code += "        list.removeAll(list);\n";
        code += "        list.addAll("+classBean.getName()+"DAO.loadView(connection));\n";
        code += "        while(mTable.getRowCount()>0) mTable.removeRow(0);\n";
        code += "        for(int i = 0; i < list.size(); i++) {\n";
        if(classBean.getAttributes().size()==1){
            code += "            java.util.List line = new java.util.ArrayList();\n";
            code += "            line.add(list.get(i));\n";
        } else {
            code += "            java.util.List line = (java.util.List)list.get(i);\n";
        }
        code += "            mTable.addRow(line.toArray());\n";
        code += "        }\n";
        code += "        if(lineSel>=0 && lineSel<list.size()) tTable.setRowSelectionInterval(lineSel, lineSel);\n";
        code += "    }\n";

        code += "\n";
        code += "    /** This method is called from within the constructor to\n";
        code += "     * initialize the form.\n";
        code += "     * WARNING: Do NOT modify this code. The content of this method is\n";
        code += "     * always regenerated by the Form Editor.\n";
        code += "     */\n";
        code += "    @SuppressWarnings(\"unchecked\")\n";
        code += "    // <editor-fold defaultstate=\"collapsed\" desc=\"Generated Code\">//GEN-BEGIN:initComponents\n";
        code += "    private void initComponents() {\n";
        code += "        sTable = new javax.swing.JScrollPane();\n";
        code += "        tTable = new javax.swing.JTable();\n";
        code += "        pButtons = new javax.swing.JPanel();\n";
        code += "        bAdd = new javax.swing.JButton();\n";
        code += "        bRem = new javax.swing.JButton();\n";
        code += "        bEdit = new javax.swing.JButton();\n";
        code += "        bPrint = new javax.swing.JButton();\n";
        code += "        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);\n";
        code += "        setTitle(\"Tabela de "+classBean.getName()+"\");\n";
        code += "        setModal(true);\n";
        code += "        tTable.setModel(new javax.swing.table.DefaultTableModel(\n";
        code += "            new Object [][] {\n";
        code += "            },\n";
        code += "            new String [] {\n";
        code += "                ";
        for(project.Attribute att : classBean.getAttributes()){
            code += getAttributeGen(att).genModelTitle();
        }
        code = code.substring(0, code.length()-2);
        code += "\n";
        code += "            }\n";

        code += "        ) {\n";
        code += "            Class[] types = new Class [] {\n";
        code += "                ";
        for(project.Attribute att : classBean.getAttributes()){
            code += getAttributeGen(att).genModelType();
        }
        code = code.substring(0, code.length()-2);
        code += "\n";
        code += "            };\n";

        code += "            boolean[] canEdit = new boolean [] {\n";
        code += "                ";
        for(project.Attribute att : classBean.getAttributes()){
            code += getAttributeGen(att).genModelEdit();
        }
        code = code.substring(0, code.length()-2);
        code += "\n";
        code += "            };\n";

        code += "            public Class getColumnClass(int columnIndex) {\n";
        code += "                return types [columnIndex];\n";
        code += "            }\n";
        code += "            public boolean isCellEditable(int rowIndex, int columnIndex) {\n";
        code += "                return canEdit [columnIndex];\n";
        code += "            }\n";
        code += "        });\n";
        code += "        tTable.addMouseListener(new java.awt.event.MouseAdapter() {\n";
        code += "            public void mouseClicked(java.awt.event.MouseEvent evt) {\n";
        code += "                tTableMouseClicked(evt);\n";
        code += "            }\n";
        code += "        });\n";
        code += "        sTable.setViewportView(tTable);\n";
        code += "        getContentPane().add(sTable, java.awt.BorderLayout.CENTER);\n";
        code += "        pButtons.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));\n";
        code += "        bAdd.setIcon(new javax.swing.ImageIcon(getClass().getResource(\"/toolbox/images/stock_new-16.png\"))); // NOI18N\n";
        code += "        bAdd.setMnemonic('N');\n";
        code += "        bAdd.setText(\"Adicionar\");\n";
        code += "        bAdd.addActionListener(new java.awt.event.ActionListener() {\n";
        code += "            public void actionPerformed(java.awt.event.ActionEvent evt) {\n";
        code += "                bAddActionPerformed(evt);\n";
        code += "            }\n";
        code += "        });\n";
        code += "        pButtons.add(bAdd);\n";
        code += "        bRem.setIcon(new javax.swing.ImageIcon(getClass().getResource(\"/toolbox/images/stock_delete-16.png\"))); // NOI18N\n";
        code += "        bRem.setMnemonic('R');\n";
        code += "        bRem.setText(\"Remover\");\n";
        code += "        bRem.addActionListener(new java.awt.event.ActionListener() {\n";
        code += "            public void actionPerformed(java.awt.event.ActionEvent evt) {\n";
        code += "                bRemActionPerformed(evt);\n";
        code += "            }\n";
        code += "        });\n";
        code += "        pButtons.add(bRem);\n";
        code += "        bEdit.setIcon(new javax.swing.ImageIcon(getClass().getResource(\"/toolbox/images/stock_open-16.png\"))); // NOI18N\n";
        code += "        bEdit.setMnemonic('E');\n";
        code += "        bEdit.setText(\"Editar\");\n";
        code += "        bEdit.addActionListener(new java.awt.event.ActionListener() {\n";
        code += "            public void actionPerformed(java.awt.event.ActionEvent evt) {\n";
        code += "                bEditActionPerformed(evt);\n";
        code += "            }\n";
        code += "        });\n";
        code += "        pButtons.add(bEdit);\n";
        code += "        bPrint.setIcon(new javax.swing.ImageIcon(getClass().getResource(\"/toolbox/images/stock_print-16.png\"))); // NOI18N\n";
        code += "        bPrint.setMnemonic('P');\n";
        code += "        bPrint.setText(\"Imprimir\");\n";
        code += "        bPrint.addActionListener(new java.awt.event.ActionListener() {\n";
        code += "            public void actionPerformed(java.awt.event.ActionEvent evt) {\n";
        code += "                bPrintActionPerformed(evt);\n";
        code += "            }\n";
        code += "        });\n";
        code += "        pButtons.add(bPrint);\n";
        code += "        getContentPane().add(pButtons, java.awt.BorderLayout.SOUTH);\n";
        code += "        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();\n";
        code += "        setBounds((screenSize.width-800)/2, (screenSize.height-600)/2, 800, 600);\n";
        code += "    }// </editor-fold>//GEN-END:initComponents\n";

        code += "\n";
        code += "    private void bAddActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bAddActionPerformed\n";
        code += "        "+classBean.getName()+" "+classBean.getNameL()+" = new "+classBean.getName()+"();\n";
        code += "        "+classBean.getNameL()+" = new "+classBean.getName()+"Form(this, connection, "+classBean.getNameL()+").showInputDialog();\n";
        code += "        if("+classBean.getNameL()+"!=null) {\n";
        code += "            try {\n";
        code += "                "+classBean.getName()+"DAO.insert(connection, "+classBean.getNameL()+");\n";
        code += "                refresh();\n";
        code += "            } catch(java.sql.SQLException e) {\n";
        code += "                e.printStackTrace();\n";
        code += "                javax.swing.JOptionPane.showMessageDialog(this, \"Falha na gravação do banco de dados!\\n\"+e.getMessage(),\"Aviso\",javax.swing.JOptionPane.ERROR_MESSAGE);\n";
        code += "            }\n";
        code += "        }\n";
        code += "    }//GEN-LAST:event_bAddActionPerformed\n";

        code += "\n";
        code += "    private void bRemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bRemActionPerformed\n";
        code += "        if(tTable.getSelectedRow()>=0) {\n";
        code += "            try {\n";
        code += "                "+classBean.getName()+" "+classBean.getNameL()+" = "+classBean.getName()+"DAO.loadBy"+classBean.getPrimaryKey().getNameU()+"(connection, ("+classBean.getPrimaryKey().getJavaType()+")tTable.getValueAt(tTable.getSelectedRow(), 0));\n";
        code += "                if(javax.swing.JOptionPane.showConfirmDialog(this, \"Deseja excluir o "+classBean.getName()+" \"+"+classBean.getNameL()+".get"+classBean.getPrimaryKey().getNameU()+"()+\"?\",\"Questão\",javax.swing.JOptionPane.OK_CANCEL_OPTION)==javax.swing.JOptionPane.OK_OPTION) {\n";
        code += "                    "+classBean.getName()+"DAO.delete(connection, "+classBean.getNameL()+");\n";
        code += "                    list.remove(tTable.getSelectedRow());\n";
        code += "                    refresh();\n";
        code += "                }\n";
        code += "            } catch(java.sql.SQLException e){\n";
        code += "                e.printStackTrace();\n";
        code += "                javax.swing.JOptionPane.showMessageDialog(this, \"Falha na exclusão do banco de dados!\\n\"+e.getMessage(),\"Aviso\",javax.swing.JOptionPane.ERROR_MESSAGE);\n";
        code += "            }\n";
        code += "        }\n";
        code += "    }//GEN-LAST:event_bRemActionPerformed\n";

        code += "\n";
        code += "    private void bEditActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bEditActionPerformed\n";
        code += "        if(tTable.getSelectedRow()>=0) {\n";
        code += "            try {\n";
        code += "                "+classBean.getName()+" "+classBean.getNameL()+" = "+classBean.getName()+"DAO.loadBy"+classBean.getPrimaryKey().getNameU()+"(connection, ("+classBean.getPrimaryKey().getJavaType()+")tTable.getValueAt(tTable.getSelectedRow(), 0));\n";
        code += "                "+classBean.getNameL()+" = new "+classBean.getName()+"Form(this, connection, "+classBean.getNameL()+").showInputDialog();\n";
        code += "                if("+classBean.getNameL()+"!=null) {\n";
        code += "                    "+classBean.getName()+"DAO.update(connection, "+classBean.getNameL()+");\n";
        code += "                    refresh();\n";
        code += "                }\n";
        code += "            } catch(java.sql.SQLException e){\n";
        code += "                e.printStackTrace();\n";
        code += "                javax.swing.JOptionPane.showMessageDialog(this, \"Falha na gravação do banco de dados!\\n\"+e.getMessage(),\"Aviso\",javax.swing.JOptionPane.ERROR_MESSAGE);\n";
        code += "            }\n";
        code += "        }\n";
        code += "    }//GEN-LAST:event_bEditActionPerformed\n";

        code += "\n";
        code += "    private void tTableMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tTableMouseClicked\n";
        code += "        if(evt.getClickCount()>=2){\n";
        code += "            bEditActionPerformed(null);\n";
        code += "        }\n";
        code += "    }//GEN-LAST:event_tTableMouseClicked\n";

        code += "\n";
        code += "    private void bPrintActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bPrintActionPerformed\n";
        code += "        javax.swing.table.DefaultTableModel mTable = (javax.swing.table.DefaultTableModel)tTable.getModel();\n";
        code += "        String print = \"\";\n";
        code += "        print += \"<html>\";\n";
        code += "        print += \"<body>\";\n";
        code += "        print += \"<table border=1 width=100%>\";\n";
        code += "        print += \"<caption>Tabela de "+classBean.getName()+"</caption>\";\n";
        code += "        print += \"<tr>\";\n";
        code += "        for(int j=0;j<mTable.getColumnCount();j++)\n";
        code += "            print += \"<th>\"+mTable.getColumnName(j);\n";
        code += "        for(int i=0;i<mTable.getRowCount();i++){\n";
        code += "            print += \"<tr>\";\n";
        code += "            for(int j=0;j<mTable.getColumnCount();j++)\n";
        code += "                print += \"<td>\"+mTable.getValueAt(i,j);\n";
        code += "        }\n";
        code += "        print += \"</table>\";\n";
        code += "        print += \"</body>\";\n";
        code += "        print += \"</html>\";\n";
        code += "        new toolbox.print.PrintHTML(print);\n";
        code += "    }//GEN-LAST:event_bPrintActionPerformed\n";

        code += "\n";
        code += "    // Variables declaration - do not modify//GEN-BEGIN:variables\n";
        code += "    private javax.swing.JButton bAdd;\n";
        code += "    private javax.swing.JButton bEdit;\n";
        code += "    private javax.swing.JButton bPrint;\n";
        code += "    private javax.swing.JButton bRem;\n";
        code += "    private javax.swing.JPanel pButtons;\n";
        code += "    private javax.swing.JScrollPane sTable;\n";
        code += "    private javax.swing.JTable tTable;\n";
        code += "    // End of variables declaration//GEN-END:variables\n";
        code += "}\n";
        return code;
    }
}
